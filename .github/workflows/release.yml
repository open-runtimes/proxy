name: "Release"

on:
  release:
    types: [published]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - run: git checkout HEAD^2

    - name: Build and Push Docker Image
      run: |
        export COMPOSE_INTERACTIVE_NO_CLI
        export DOCKER_BUILDKIT=1
        export COMPOSE_DOCKER_CLI_BUILD=1
        export BUILDKIT_PROGRESS=plain
        echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        docker build -t meldiron/ci-test-proxy:${{ github.ref }} .
        docker build -t meldiron/ci-test-proxy:latest .
        docker push "meldiron/ci-test-proxy:${{ github.ref }}
        docker push meldiron/ci-test-proxy:latest
